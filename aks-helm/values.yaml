# Custom AWX Operator Configuration

replicaCount: 1

image:
  repository: quay.io/ansible/awx-operator 
  pullPolicy: IfNotPresent
  tag: "2.19.1"

serviceAccount:
  create: true
  annotations:
    kubernetes.io/managed-by: "helm"
  name: "awx-operator"

# Security Context
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000

securityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 1000
  capabilities:
    drop:
    - ALL

# Resource Limits
resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 128Mi

nodeSelector: {}
tolerations: []
affinity: {}

# AWX Configuration with LoadBalancer and LDAP for AKS
AWX:
  enabled: true
  name: awx
  spec:
    service_type: LoadBalancer
    hostname: awx.company.com
    
    # AKS LoadBalancer annotations
    service_annotations:
      service.beta.kubernetes.io/azure-load-balancer-resource-group: "awx-rg"
      # service.beta.kubernetes.io/azure-load-balancer-internal: "true"  # Uncomment for internal LB
      # service.beta.kubernetes.io/azure-load-balancer-internal-subnet: "awx-subnet"  # For internal LB
      # service.beta.kubernetes.io/azure-pip-name: "awx-public-ip"  # For static IP
    
    # Production resource requirements
    web_resource_requirements:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: 2000m
        memory: 4Gi
    
    task_resource_requirements:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: 2000m
        memory: 4Gi
    
    # LDAP Authentication Configuration
    extra_settings:
      - setting: AUTH_LDAP_SERVER_URI
        value: "ldap://your-ldap-server.company.com:389"
      - setting: AUTH_LDAP_BIND_DN
        value: "CN=awx-service,OU=Service Accounts,DC=company,DC=com"
      - setting: AUTH_LDAP_USER_SEARCH
        value: "LDAPSearch('OU=Users,DC=company,DC=com', ldap.SCOPE_SUBTREE, '(sAMAccountName=%(user)s)')"
      - setting: AUTH_LDAP_GROUP_SEARCH
        value: "LDAPSearch('OU=Groups,DC=company,DC=com', ldap.SCOPE_SUBTREE, '(objectClass=group)')"
      - setting: AUTH_LDAP_USER_ATTR_MAP
        value: "{'first_name': 'givenName', 'last_name': 'sn', 'email': 'mail'}"
      - setting: AUTH_LDAP_GROUP_TYPE
        value: "ActiveDirectoryGroupType()"
      - setting: AUTH_LDAP_REQUIRE_GROUP
        value: "CN=AWX-Users,OU=Groups,DC=company,DC=com"
      - setting: AUTH_LDAP_USER_FLAGS_BY_GROUP
        value: "{'is_superuser': 'CN=AWX-Admins,OU=Groups,DC=company,DC=com'}"
      - setting: ALLOWED_HOSTS
        value: "['awx.company.com', 'localhost']"
    
    # PostgreSQL storage requirements
    postgres_storage_requirements:
      requests:
        storage: 50Gi
        
  # PostgreSQL configuration
  postgres:
    enabled: true

# LDAP Bind Password Secret Reference
env:
- name: AUTH_LDAP_BIND_PASSWORD
  valueFrom:
    secretKeyRef:
      name: awx-ldap-secret
      key: bind_password